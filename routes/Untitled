Key findings (blocking)
Brand model file is replaced by a route (it no longer defines a schema). There is no ristaBranchCode/analyticsPeriod field, and the model itself is gone. This breaks all Brand persistence and the intended settings flow.
/api/brand/settings is not registered in backend/index.js, so the frontend cannot save branch/period even if the route file existed.
authMiddleware only sets req.user; req.brand is never attached. The brand-settings route expects req.brand._id and will always 401.
/api/dashboard/stats still uses brand.ristaOutletId and auto-link by name. It ignores the required ristaBranchCode and analyticsPeriod from the Brand document. It also passes branch: brand.ristaOutletId to Rista.
KPT fetch uses getSalesPage, but that client now returns an array; the route still assumes salesResp.sales || salesResp.data. This will produce empty KPT data.
Client (Rista) review
JWT per request is correct (iss, iat, jti; no reuse).
Calls use branch and period parameters in getAnalyticsSummary/getSalesPage.
ResourceNotFound is normalized via handleNotFound.
What to fix (code-level)
1) Restore models/brand.js to a schema with at least:
brandName, status, etc. (as before)
ristaBranchCode: { type: String, default: null }
analyticsPeriod: { type: String, default: null }
Keep existing fields (ristaOutletId if still needed for other flows).
2) Add middleware to attach the brand to the request (or inline fetch):
In authMiddleware, after decoding, look up the Brand by brandName (or userId) and set req.brand.
Alternatively, in each route, fetch const brand = await Brand.findOne({ brandName: req.user.brandName }).
3) Register the brand settings route:
Import it (rename file to something like routes/brand.settings.routes.js) and mount in index.js with app.use('/api', brandSettingsRoute) (or /api/brand).
4) Fix /api/brand/settings route:
Use req.brand (from middleware) or fetch by req.user.brandName.
Persist ristaBranchCode and analyticsPeriod.
Keep it auth-only, not admin.
5) Fix /api/dashboard/stats:
Use brand.ristaBranchCode (not outletId) when calling:
getAnalyticsSummary({ branch: brand.ristaBranchCode, period })
getSalesPage({ branch: brand.ristaBranchCode, period })
Use period from brand.analyticsPeriod (fallback to today or query override).
Remove outlet auto-linking here (or ignore it for analytics).
Adjust sales parsing since getSalesPage returns an array now: const sales = salesResp;.
Return statsAvailable:false with guidance if branchCode or period missing.
6) KPT calc:
Current helper is fine; just ensure it receives the correct sales array.
7) Frontend (Dashboard.jsx) to verify once backend is fixed:
Inputs for Branch Code + Date.
On “Search”, POST /api/brand/settings; on success, refetch GET /api/dashboard/stats without passing branch/period in the query.
Render revenue, totalOrders, AOV (revenue/totalOrders), avgKPT.
Conclusion
The main blockers are: missing Brand schema, unregistered brand settings route, req.brand not set, and dashboard stats using outletId instead of branch/period. The Rista client and JWT generation look correct; the 403s are unrelated to this flow.